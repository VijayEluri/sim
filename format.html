<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<style type="text/css">
#inpanel {
	float: left;
}
#outpanel {
	float: left;
	clear: right;
}
#resultout {
	width: 100%;
	height: 33em;
	overflow: scroll ;
	border-width: 2px;
	border-style: outset ;
}
.copy {
	line-height:100%;
	font-size: x-small;
	text-align: right;
}
textarea {
	overflow: scroll ;
	word-wrap: normal ;
}
</style>
</head>

<body>

<div id='inpanel'>
<textarea id='textin' rows='33' cols='35'></textarea>
</div>

<div id='outpanel'>
<textarea id='textout' rows='33' cols='80'></textarea>
<div id='resultout'></div>
</div>

<div style='clear:both;'>
	<input type='button' value='开始转换' id='startb'/>
	<input type='button' value='显示切换' id='swapd'/>
	<input type='button' value='复制源码' id='clipboard'/>
</div>

<div class='copy'>
yanming-sohu@sohu.com<br/>
CatfoOD<br/>
</div>

</body>

<script language="javascript">

////////////////////---- 渲染器定义 ---------------------------------------////

// CatfoOD 2010-8-20
// yanming-sohu@sohu.com

// 渲染器的定义
var no_render = function(key) {
	return key;
}

// 空白符
function sp_render(sp) {
	var r = false;
	if (sp==' ') {
		r = '&nbsp;';
	} 
	else if (sp=='\t'){
		r = '&nbsp;&nbsp;&nbsp;&nbsp;';
	}
	return r;
}

// 关键字
var key_render = function(k) {
	return "<span style='color:blue;'>" + k + "</span>";
}

// 换行
var enter_render = function(en) {
	return "<br/>\n";
}

// 行号
var line_render = function (l) {
	return "<div style='float:left;width:40px;background-Color:#bbbbbb;" +
		"text-align:center;font-family:Courier'>"+l+"</div>";
}

// 全局字体
var font_style = function() {
	return 'line-height:100%;font-size:x-small';
}

// 运算符
var tag_render = function(t) {
	return "<b>" + t + "</b>"
}

// 数字
var num_render = function(num) {
	return "<span style='color:#BC8F8F;'>" + num + "</span>";
}

// 注释
var comment_render = function(c) {
	return "<font style='color:green;'>" + c + "</font>";
}


////////////////////---- 符号定义 ---------------------------------------////

var tag = {
	"{":	tag_render
,	"}":	tag_render
,	"[":	tag_render
,	"]":	tag_render
,	"(":	tag_render
,	")":	tag_render
,	"=":	tag_render
,	"+":	tag_render
,	"-":	tag_render
,	"*":	tag_render
,	"/":	tag_render
,	"'":	tag_render
,	"\"":	tag_render
,	".":	tag_render
,	";":	tag_render
,	"<":	tag_render
,	">":	tag_render
,	"?":	tag_render
,	"!":	tag_render
,	":":	tag_render
,	"|":	tag_render
,	"&":	tag_render
,	"%":	tag_render
,	",":	tag_render
};

var key = {
	"int":			key_render
,	"float":		key_render
,	"auto":		key_render
,	"double":		key_render
,	"struct":		key_render
,	"break":		key_render
,	"else":			key_render
,	"long":			key_render
,	"switch":		key_render
,	"case":		key_render
,	"enum":		key_render
,	"register":	key_render
,	"typedef":		key_render
,	"char":		key_render
,	"extern":		key_render
,	"return":		key_render
,	"union":		key_render
,	"const":		key_render
,	"short":		key_render
,	"unsigned":	key_render
,	"continue":	key_render
,	"for":			key_render
,	"signed":		key_render
,	"void":			key_render
,	"default":		key_render
,	"goto":		key_render
,	"sizeof":		key_render
,	"volatile":		key_render
,	"do":			key_render
,	"while":		key_render
,	"static":		key_render
,	"auto":		key_render
,	"if":			key_render
};

////////////////////---- 变量初始化 ---------------------------------------////

var $ = function(id) {
	return  document.getElementById(id);
}

var intext = $('textin');
var outtext = $('textout');
var result_out = $('resultout');

var swap_button = $('swapd');
var start_button = $('startb');
var copy_button = $('clipboard');

result_out.style.display='none';
start_button.onclick = startTran;

var swap_cu = true;

////////////////////---- 事件初始化 ---------------------------------------////

swap_button.onclick = function() {
	if (swap_cu) {
		outtext.style.display='none';
		result_out.style.display='block';
		write_display();
	} else {
		outtext.style.display='block';
		result_out.style.display='none';
	}
	swap_cu = !swap_cu;
}

function startTran() {
	var stext = intext.innerHTML;
	//stext = parse(stext);
	stext = parse_src(stext);
	outtext.value = stext;
	write_display();
}

function write_display() {
	result_out.innerHTML = outtext.value;
}

copy_button.onclick = function() {
	window.clipboardData.setData("Text",outtext.innerText); 
}

////////////////////---- 词法解析 ---------------------------------------////

function parse_src(str) {
	var result = [];
	var size = str.length;
	
	var word = "";
	result.line = 1;
	
	function pushWord(ch) {
		render_word(word, result);
		word = "";
		
		if (ch) {
			render_word(ch, result);
		}
	}
	
	var ci = 0;
	
	function next() {
		if (ci<size) {
			return str.charAt(ci++);
		} else {
			return false;
		}
	}
	
	// 范围标记的记号
	var save = [];
	
	function when_newline_cleartag() {
		save.comment = false;
		newline();
	}
	
	function newline() {
		result.push(line_render(result.line++));
	}
	
	result.push("<font style='" + font_style() + "'>");
	newline();
	
	while(true) {
		var ch = next();
		if (!ch) break;
		
		// 符号的解析顺序即优先级
		
		// 换行
		if (ch=='\r') {
			/* 处理'\r\n'的代码
			when_newline_cleartag();
			
			var ch2 = next();
			if (ch2 && ch2=='\n') {
				pushWord('\n');
				continue;
			} else {
				pushWord('\n');
				ch = ch2;
			}
			*/
			continue;
		}
		
		if (ch=='\n') {
			pushWord('\n');
			when_newline_cleartag();
			continue;
		}
		
		// 单行注释
		if (save.comment) {
			word += ch;
			continue;
		}
		
		if (ch=='/') {
			var ch2 = next();
			if (ch2 && ch2=='/') {
				word += '//';
				save.comment = true;
				continue;
			}
		}
		
		// html转义符
		if (save.html) {
			word += ch;
			if (ch==';') {
				pushWord();
				save.html = false;
			}
		}
		else if (ch=='&') {
			save.html = true;
			pushWord();
			word += ch;
		}
		// 运算符
		else if (tag[ch]) {
			pushWord(ch);
		}
		// 空白符
		else if (ch=='\t' || ch==' ') {
			pushWord(ch);
		}
		// 普通字符
		else {
			word += ch;
		}
	}
	pushWord();
	result.push("<font/>");
	
	return result.join("");;
}

function render_word(word, result) {
	var render = false;
	
	if (word=='\n') {
		render = enter_render;
	}
	else if (word.indexOf('//')==0) {
		render = comment_render;
	}
	else if (word==' ' || word=='\t') {
		render = sp_render;
	} 
	else {
		render = key[word];
		
		if (!render) {
			render = tag[word];
			
			if (!render) {
				var num = parseFloat(word);
				
				if (num) {
					render = num_render;
				}
			}
		}
	}
	
	if (render) {
		result.push(render(word));
	} else {
		result.push(word);
	}
}

</script>

</html>
